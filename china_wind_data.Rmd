---
title: "China Wind Data"
author: "Sebastian Geis"
date: "2024-01-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE}
library(progress)
library(units)
library(rvest)
library(httr)

library(metR)
library(raster)
library(terra)
library(sf)
library(stars)
library(ggspatial)
library(gstat)

library(tidyverse)
library(lubridate)
library(vroom)
#library(furrr)
```

# Get list of stations in China
Station list from [NOAA](https://www.ncei.noaa.gov/pub/data/noaa/isd-history.csv)

Specification:
```
 USAF = Air Force station ID. May contain a letter in the first position.
 WBAN = NCDC WBAN number
 CTRY = FIPS country ID
   ST = State for US stations
 ICAO = ICAO ID
  LAT = Latitude in thousandths of decimal degrees
  LON = Longitude in thousandths of decimal degrees
 ELEV = Elevation in meters
BEGIN = Beginning Period Of Record (YYYYMMDD). There may be reporting gaps within the P.O.R.
  END = Ending Period Of Record (YYYYMMDD). There may be reporting gaps within the P.O.R.
```

```{r}
download.file(url = "https://www.ncei.noaa.gov/pub/data/noaa/isd-history.csv", destfile = "./data/isd-history.csv", method = "curl")

stations_isd_full <- read_csv("./data/isd-history.csv") %>%
  janitor::clean_names()

stations_isd_full_china <- stations_isd_full %>%
  filter(ctry == "CH") %>%
  pull(usaf)
```

Keep only station ids that are found in in the [isd lite dataset](https://www.ncei.noaa.gov/pub/data/noaa/isd-lite/) for every year from 1989 to 1999
```{r eval=FALSE}
links <- character()

for(year in 1989:1999){
  print(year)
  
  url <- paste0("https://www.ncei.noaa.gov/pub/data/noaa/isd-lite/", year, "/")
  
  html <- GET(url) %>% content("text") %>% read_html()
  
  links_new <- html %>% 
    html_nodes("a") %>%
    html_attr("href") %>%
  # Filter out links that end with .gz
    .[grepl("\\.gz$", .)]
  
  links <- append(links, links_new)
}

remaining_stations <- links %>%
  tibble() %>%
  rename(full_name = 1) %>%
  mutate(id = str_extract(full_name, "^\\d{6}"),
         year = str_extract(full_name, "(\\d{4})\\.gz$", group = 1)) %>%
  select(-full_name) %>%
  group_by(id) %>%
  count() %>%
  filter(n == 11,
         id %in% stations_isd_full_china) %>%
  pull(id)

length(remaining_stations)
```

Get location of stations
```{r}
stations_location <- stations_isd_full %>%
  select(id = usaf, lat, lon) %>%
  filter(id %in% remaining_stations) %>%
  st_as_sf(coords = c("lon", "lat"), crs = 4326)
```

# Download data
I use the [ISD lite data](https://www.ncei.noaa.gov/pub/data/noaa/isd-lite/), which is smaller but still contains wind speed and direction.

Download using loop
```{r warning=FALSE, eval=FALSE}
base_url_isd_lite <- "https://www.ncei.noaa.gov/pub/data/noaa/isd-lite/"

years <- 1989:1999
#years <- 1990

dir.create("./data/data_isd_lite", showWarnings = FALSE)

for(year in years){
  print(year)
  
  for (station in remaining_stations) {
    file_name <- paste0(station, "-99999-", year, ".gz")
    file_url <- paste0(base_url_isd_lite, year, "/", file_name)
    output_file <- paste0("./data/data_isd_lite/", year, "_", file_name)
    
    sink("/dev/null")
    try(download.file(file_url, output_file, method = "auto", quiet = TRUE, mode = "wb"))
    sink()
  }
}
```

Download with `curl::multi_download()`.
Is MUCH faster, but in the end a few files are missing.
```{r eval=FALSE}
base_url_isd_lite <- "https://www.ncei.noaa.gov/pub/data/noaa/isd-lite/"
years <- 1989:1999

dir.create("data_isd_lite", showWarnings = FALSE)

# Create vector of all URLs and resulting filenames
urls <- character()
output_files <- character()

for(year in years){
  for (station in remaining_stations) {
    file_name <- paste0(station, "-99999-", year, ".gz")
    urls <- append(urls, paste0(base_url_isd_lite, year, "/", file_name))
    output_files <- append(output_files, paste0("./data/data_isd_lite/", year, "_", file_name))
  }
}

# Download files
curl::multi_download(urls = urls, destfiles = output_files, progress = TRUE)
```

**Now unzip all files manually**, with MacOS or Linux use `gunzip *.gz` in the data directory.
Reading in all files and combining them, then writing them back as one file
```{r}
# List all the files in the "data_isd_lite" folder
files <- list.files("./data/data_isd_lite", pattern = "\\d{4}$", full.names = TRUE)

# Define the column types for the columns
positions <- fwf_cols(year = c(1,4), month = c(6,7), day = c(9,11), hour = c(12,13), temp = c(14,19), dew = c(20,24), pres = c(26,31), wind_dir = c(32,37), wind_speed = c(38,43))

types <- cols("i", "i", "i", "i", "i", "i", "i", "i", "i")
                      

# Read and combine the files into a single data frame
data_isd_lite_combined <- bind_rows(lapply(files, function(file) {
  readr::read_fwf(file, col_positions = positions,
         col_types = types) %>%
    mutate(id = str_extract(file, "data_isd_lite\\/\\d{4}_(\\d+)-\\d+-\\d{4}", group = 1)) %>%
    mutate(date = ymd_h(paste(year, month, day, hour)), .keep = "unused") %>%
    select(id, date, wind_dir, wind_speed)
}))

write_csv(data_isd_lite_combined, "./data/data_isd_lite_combined.csv")
```

```{r}
data_isd_lite_combined <- read_csv("./data/data_isd_lite_combined.csv")

data_isd_lite_combined
```


# Data preparation
Find average wind direction
```{r}
# Define a function to compute the mean wind direction
mean_wind_direction <- function(wind_directions) {
  wind_directions_rad <- (pi / 180) * wind_directions
  mean_sin <- mean(sin(wind_directions_rad))
  mean_cos <- mean(cos(wind_directions_rad))
  avg_wind_direction_rad <- atan2(mean_sin, mean_cos)
  avg_wind_direction <- (180 / pi) * avg_wind_direction_rad
  if (avg_wind_direction < 0) {
    avg_wind_direction <- avg_wind_direction + 360
  }
  return(avg_wind_direction)
}

# Calculate the average wind direction over whole period by station
# Cut out observations that are far away from china
data_isd_lite_mean <- data_isd_lite_combined %>%
  filter(wind_dir != -9999, wind_speed != -9999) %>%
  group_by(id) %>%
  summarise(avg_wind_dir = mean_wind_direction(wind_dir), 
            avg_wind_speed = mean(wind_speed)) %>%
  left_join(stations_location, by = join_by(id)) %>%
  st_as_sf() %>%
  st_filter(china_border %>% st_buffer(dist = 100000))
```

Saving / Reading 'data_isd_lite_mean'
```{r}
#st_write(data_isd_lite_mean, "./data/data_isd_lite_mean.gpkg", append = FALSE)

data_isd_lite_mean <- st_read("./data/data_isd_lite_mean.gpkg")

data_isd_lite_mean
```

Simple Plotting
```{r}
china_border <- giscoR::gisco_get_countries(country = "CN")

ggplot()+
  geom_sf(data = china_border)+
  geom_sf(data = data_isd_lite_mean)+
  theme_bw()+
  labs(x = "lon", y = "lat")
```

Plotting with wind speed and direction
```{r}
ggplot() +
  geom_sf(data = china_border) +
  geom_sf(data = data_isd_lite_mean, aes(color = avg_wind_speed), size = 1) +
  metR::geom_arrow(data = data_isd_lite_mean %>% filter(avg_wind_speed < 150), 
                   aes(x = st_coordinates(geom)[, 1], 
                       y = st_coordinates(geom)[, 2], 
                       #mag = avg_wind_speed, 
                       mag = 1,
                       angle = avg_wind_dir, 
                       color = avg_wind_speed),
                   arrow.length = 0.3,
                   arrow.type = "open",
                   pivot = 0,
                   direction = 2,
                   start = 90+180) +
  coord_sf()+
  scale_color_viridis_c(option = "plasma")+
  scale_mag(max_size = .5)+
  theme_bw()+
  labs(x = "lon", 
       y = "lat",
       color = "Average\nWind\nSpeed")+
  guides(mag = FALSE)

#ggsave("./plots/plot_raw_windspeed.pdf", width = 10, height = 6)
```

To check if plotted direction is correct with an example plot and custom wind direction.
```{r}
data_isd_lite_mean %>% slice_head(n = 1) %>% 
  mutate(avg_wind_dir = 45) %>%
  ggplot()+
  geom_sf()+
  metR::geom_arrow(aes(x = st_coordinates(geom)[, 1], 
                       y = st_coordinates(geom)[, 2], 
                       mag = .5, 
                       angle = avg_wind_dir, 
                       color = avg_wind_speed),
                   arrow.type = "open",
                   pivot = 0,
                   direction = 2,
                   start = 90+180)
```

# Interpolation
Reading in .nc file. FILE IS MISSING NOW.
```{r eval=FALSE}
#nc_data <- raster::brick("V5GL02.HybridPM25.China.200001-200012.nc")
#nc_data

#plot(nc_data)
```

datum=WGS84
extent     : 73, 140, 18, 54  (xmin, xmax, ymin, ymax)
resolution : 0.01, 0.01  (x, y)

Create grid
```{r}
# Set grid parameters
xmin <- 73
xmax <- 140
ymin <- 18
ymax <- 54
xres <- 0.01
yres <- 0.01

# Create grid
# Need a larger grid for cropping china and interpolation
grid_large <- raster(xmn = xmin, xmx = xmax, ymn = ymin, ymx = ymax, res = c(xres*10, yres*10), crs = "+proj=longlat +datum=WGS84 +no_defs")
grid <- raster(xmn = xmin, xmx = xmax, ymn = ymin, ymx = ymax, res = c(xres, yres), crs = "+proj=longlat +datum=WGS84 +no_defs")

# Set random values to grid
# For some reason, without this the st_crop does not work
values(grid_large) <- runif(n = length(grid_large), min = 0, max = 1)
values(grid) <- runif(n = length(grid), min = 0, max = 1)

# Convert terra grid to stars grid,
# Only keep cells that are within Chinas borders
grid_large_stars <- grid_large %>% st_as_stars %>%
  st_crop(china_border %>% st_simplify(dTolerance = 10000))

#plot(grid_large_stars)
```

Using fitting model from gstat library, creating interpolation for wind speed
```{r}
# Fit model
v <- variogram(avg_wind_speed~1, data_isd_lite_mean)
v.m <- fit.variogram(v, vgm(50, "Gau", 500, 10))

plot(v, v.m, plot.numbers = TRUE)

# Interpolation
k <- krige(avg_wind_speed~1, data_isd_lite_mean, grid_large_stars, v.m) %>%
  select(wind_speed = var1.pred)

# Plotting
ggplot() + 
  geom_stars(data = k, aes(fill = wind_speed, x = x, y = y)) + 
  xlab(NULL) + ylab(NULL) +
  geom_sf(data = china_border, fill = NA) + 
  geom_sf(data = data_isd_lite_mean, size = 1)+
  theme_bw()+
  scale_fill_viridis_c(na.value = "transparent")+
  labs(fill = "Average\nWindspeed")

#ggsave("./plots/plot_kriging_windspeed.pdf", width = 10, height = 6)
```

## Wind direction
Example for calculating wind directions
```{r}
# set example
degree <- 45

# convert to coordinates
degree_rad <- degree * pi/180

x <- cos(degree_rad)
y <- sin(degree_rad)

round(x, 2)
round(y, 2)

# convert back to degree
theta_degrees <- atan2(y, x) * 180/pi

# Adjust to ensure the angle is positive
if (theta_degrees < 0) {
  theta_degrees <- theta_degrees + 360
}

theta_degrees
```

Annotation: Wind direction of 0° means the wind is blowing from North.
```{r}
# 1. Convert wind direction to rad and coordinates
data_isd_lite_mean_coords <- data_isd_lite_mean %>%
  mutate(avg_wind_dir_rad = avg_wind_dir * pi/180,
         avg_wind_dir_x = cos(avg_wind_dir_rad),
         avg_wind_dir_y = sin(avg_wind_dir_rad))

# 2. Interpolate X and Y components separately
# Fit model for x
v_x <- variogram(avg_wind_dir_x~1, data_isd_lite_mean_coords)
v.m_x <- fit.variogram(v_x, vgm(1, "Exp", 500, 1))
k_x <- krige(avg_wind_dir_x~1, data_isd_lite_mean_coords, grid_large_stars, v.m_x) %>%
  select(pred_x = var1.pred)

# Fit model for y
v_y <- variogram(avg_wind_dir_y~1, data_isd_lite_mean_coords)
v.m_y <- fit.variogram(v_y, vgm(1, "Exp", 500, 1))
k_y <- krige(avg_wind_dir_y~1, data_isd_lite_mean_coords, grid_large_stars, v.m_y) %>%
  select(pred_y = var1.pred)

# 3. Combine models and calculate degrees
grid_large_final <- c(k, k_x, k_y) %>%
  mutate(wind_dir = atan2(pred_y, pred_x) * 180/pi,
         wind_dir = if_else(wind_dir < 0, wind_dir + 360, wind_dir))
grid_large_final
```

```{r}
set.seed(1)

sample <- grid_large_final %>% rast() %>%
  spatSample(size = 2000, xy = TRUE) %>%
  drop_na() %>%
  st_as_sf(coords = c("x", "y"), crs = 4326)

ggplot() +
  geom_sf(data = china_border) +
  geom_sf(data = sample, aes(color = wind_speed_wind_speed), size = 1) +
  metR::geom_arrow(data = sample %>% filter(wind_speed_wind_speed < 150), 
                   aes(x = st_coordinates(geometry)[, 1], 
                       y = st_coordinates(geometry)[, 2], 
                       #mag = avg_wind_speed, 
                       mag = 1,
                       angle = wind_dir_wind_dir, 
                       color = wind_speed_wind_speed),
                   arrow.length = 0.3,
                   arrow.type = "open",
                   pivot = 0,
                   direction = 2,
                   start = 90+180) +
  coord_sf()+
  scale_color_viridis_c(option = "plasma")+
  scale_mag(max_size = .5)+
  theme_bw()+
  labs(x = "lon", 
       y = "lat",
       color = "Average\nWind\nSpeed")+
  guides(mag = FALSE)

#ggsave("./plots/plot_windspeed_after_interpolation.jpg")
```

# Save raster
Convert back to terra and split raster 1:10 to get desired resolution (as grid_small)
```{r}
grid_small_final <- grid_large_final %>% select(wind_speed, wind_dir) %>% rast() %>% disagg(fact=c(10, 10))
names(grid_small_final) <- c("wind_speed", "wind_dir")

plot(grid_small_final)

#plot(grid_small_k_windspeed$var1.pred_var1.pred)
```

Write to NetCDF and load again
```{r}
#writeCDF(grid_small_final, "./data/grid_small_final.nc", overwrite = TRUE, compression = 7)

grid_small_final <- terra::rast("./data/grid_small_final.nc")
names(grid_small_final) <- c("wind_speed", "wind_dir")
```

# Calculations with firm data
Reading in firm data
```{r, message=FALSE}
# Reading in from files
data_firm_list <- list()

data_firm_list[[1]] <- read_csv("./data/firm data/m2000_firmcoordinates_wgs84.csv") %>%
  mutate(year = 2000)
data_firm_list[[2]] <- read_csv("./data/firm data/m2001_firmcoordinates_wgs84.csv") %>%
  mutate(year = 2001)
data_firm_list[[3]] <- read_csv("./data/firm data/m2002_firmcoordinates_wgs84.csv") %>%
  mutate(year = 2002)
data_firm_list[[4]] <- read_csv("./data/firm data/m2003_firmcoordinates_wgs84.csv") %>%
  mutate(year = 2003)
data_firm_list[[5]] <- read_csv("./data/firm data/m2004_firmcoordinates_wgs84.csv") %>%
  mutate(year = 2004)
data_firm_list[[6]] <- read_csv("./data/firm data/m2005_firmcoordinates_wgs84.csv") %>%
  mutate(year = 2005)
data_firm_list[[7]] <- read_csv("./data/firm data/m2006_firmcoordinates_wgs84.csv") %>%
  mutate(year = 2006)

data_firm_list <- data_firm_list %>%
  map(~.x %>% 
        drop_na() %>% 
        st_as_sf(coords = c("lng_wgs84", "lat_wgs84"), crs = 4326))

data_firm_list[[1]]

data_firm <- map_dfr(data_firm_list, identity) %>%
  drop_na() %>%
  st_as_sf(coords = c("lng_wgs84", "lat_wgs84"), crs = 4326)
```

Reading in pollution data
```{r}
# Create empty list
data_pollution_list <- list()

# Read in pollution data
data_pollution_list[[1]] <- terra::rast("./data//pollution data/V5GL02.HybridPM25.China.200001-200012.nc")
data_pollution_list[[2]] <- terra::rast("./data//pollution data/V5GL02.HybridPM25.China.200101-200112.nc")
data_pollution_list[[3]] <- terra::rast("./data//pollution data/V5GL02.HybridPM25.China.200201-200212.nc")
data_pollution_list[[4]] <- terra::rast("./data//pollution data/V5GL02.HybridPM25.China.200301-200312.nc")
data_pollution_list[[5]] <- terra::rast("./data//pollution data/V5GL02.HybridPM25.China.200401-200412.nc")
data_pollution_list[[6]] <- terra::rast("./data//pollution data/V5GL02.HybridPM25.China.200501-200512.nc")
data_pollution_list[[7]] <- terra::rast("./data//pollution data/V5GL02.HybridPM25.China.200601-200612.nc")

# Drop units, crop and combine with wind data
data_wind_pollution_list <- data_pollution_list %>% map(function(x) {
  terra::units(x) <- NA
  data_pollution_cropped <- terra::crop(x, grid_small_final)
  c(grid_small_final, data_pollution_cropped)
})

data_wind_pollution_list[[1]]
```

NEW: Creating a terra SpatRaster with layers for every year
```{r}
# Create empty list
data_pollution_list <- list()

# Read in pollution data
data_pollution_list[[1]] <- terra::rast("./data//pollution data/V5GL02.HybridPM25.China.200001-200012.nc")
data_pollution_list[[2]] <- terra::rast("./data//pollution data/V5GL02.HybridPM25.China.200101-200112.nc")
data_pollution_list[[3]] <- terra::rast("./data//pollution data/V5GL02.HybridPM25.China.200201-200212.nc")
data_pollution_list[[4]] <- terra::rast("./data//pollution data/V5GL02.HybridPM25.China.200301-200312.nc")
data_pollution_list[[5]] <- terra::rast("./data//pollution data/V5GL02.HybridPM25.China.200401-200412.nc")
data_pollution_list[[6]] <- terra::rast("./data//pollution data/V5GL02.HybridPM25.China.200501-200512.nc")
data_pollution_list[[7]] <- terra::rast("./data//pollution data/V5GL02.HybridPM25.China.200601-200612.nc")

# Drop units, crop and combine with wind data
data_pollution_list <- imap(data_pollution_list, function(data_pollution, index) {
  terra::units(data_pollution) <- NA
  data_pollution_cropped <- terra::crop(data_pollution, grid_small_final)
  
  year <- 2000 + (index - 1)  # Calculate the year based on the index
  names(data_pollution_cropped) <- paste0("GWRPM25_", year)
  
  return(data_pollution_cropped)
})

#data_pollution_list[[2]]

data_wind_pollution <- c(grid_small_final, rast(data_pollution_list))
data_wind_pollution
```

Extract pollution and wind data from cell for each firm
```{r}
data_firm_wind_pollution_list <- map2(data_wind_pollution_list, 
                                 data_firm_list, 
                                 function(data_wind_pollution, data_firm) {
  terra::extract(data_wind_pollution, data_firm, xy = TRUE) %>%
    cbind(firm_code = data_firm$firm_code,
          year = data_firm$year) %>%
    drop_na() %>%
    st_as_sf(coords = c("x", "y"), crs = 4326)
                                   }, .progress = TRUE)

data_firm_wind_pollution_list[[1]]
```

```{r}
# Save
write_rds(data_firm_wind_pollution, "./data/data_firm_wind_pollution.rds", compress = "gz")
# Restore
data_firm_wind_pollution <- read_rds("./data/data_firm_wind_pollution.rds")
```

> PROBLEM: All the functions below need to be adjusted to take data_wind_pollution as a list

## NEW
1. Average PM 2.5 concentration in the 9 cells surrounding a firm (the firm's cell itself + the 8 adjacent cells in all directions)
2. As 1. but the sum of concentrations (yes, the raw sum)
3. Inverse-distance-weighted PM 2.5 concentration across cells within a 45° cone originating from a firm's coordinate in downwind direction and for a range of 10km
4. As 3. but the simple sum of all these cells (yes, again the raw sum)
5. As 3, but taking prevalent wind-speeds into account: the range for which we take downwind cells into account is 10km if the windspeed in the firm's cell is below the median in the overall windspeed data, while it is 25km if the windspeed is above the median.
6. As 4, but using the windspeed-split as in 5.

### Surrounding cells average & sum
Cells have this layout, where cell 5 is the cell of the firm:
```
1 | 2 | 3
4 | 5 | 6
7 | 8 | 9
```

```{r}
data_firm_wind_pollution_surrounding <- data_firm_wind_pollution %>%
  # Find firm cell number and then row and column number
  mutate(cell_number = cellFromXY(data_wind_pollution, st_coordinates(.)),
         cell_row = rowFromCell(data_wind_pollution, cell_number),
         cell_col = colFromCell(data_wind_pollution, cell_number)) %>%
  # Extract surrounding cells values
  rowwise() %>%
  mutate(cell_1_GWRPM25 = terra::extract(data_wind_pollution, cellFromRowCol(data_wind_pollution, 
                                                                             row = cell_row - 1, 
                                                                             col = cell_col - 1))$GWRPM25,
         cell_2_GWRPM25 = terra::extract(data_wind_pollution, cellFromRowCol(data_wind_pollution, 
                                                                             row = cell_row - 1, 
                                                                             col = cell_col))$GWRPM25,
         cell_3_GWRPM25 = terra::extract(data_wind_pollution, cellFromRowCol(data_wind_pollution, 
                                                                             row = cell_row - 1, 
                                                                             col = cell_col + 1))$GWRPM25,
         cell_4_GWRPM25 = terra::extract(data_wind_pollution, cellFromRowCol(data_wind_pollution, 
                                                                             row = cell_row, 
                                                                             col = cell_col - 1))$GWRPM25,
         cell_5_GWRPM25 = terra::extract(data_wind_pollution, cellFromRowCol(data_wind_pollution, 
                                                                             row = cell_row, 
                                                                             col = cell_col))$GWRPM25,
         cell_6_GWRPM25 = terra::extract(data_wind_pollution, cellFromRowCol(data_wind_pollution, 
                                                                             row = cell_row, 
                                                                             col = cell_col + 1))$GWRPM25,
         cell_7_GWRPM25 = terra::extract(data_wind_pollution, cellFromRowCol(data_wind_pollution, 
                                                                             row = cell_row + 1, 
                                                                             col = cell_col - 1))$GWRPM25,
         cell_8_GWRPM25 = terra::extract(data_wind_pollution, cellFromRowCol(data_wind_pollution, 
                                                                             row = cell_row + 1, 
                                                                             col = cell_col))$GWRPM25,
         cell_9_GWRPM25 = terra::extract(data_wind_pollution, cellFromRowCol(data_wind_pollution, 
                                                                             row = cell_row + 1, 
                                                                             col = cell_col + 1))$GWRPM25) %>%
  # Calculating average and sum
  mutate(surrounding_GWRPM25_average = rowMeans(pick(cell_1_GWRPM25:cell_9_GWRPM25)),
         surrounding_GWRPM25_sum = rowSums(pick(cell_1_GWRPM25:cell_9_GWRPM25))) %>%
  tibble() %>%
  st_drop_geometry() %>%
  select(firm_code, year, GWRPM25_surrounding_mean = surrounding_GWRPM25_average, GWRPM25_surrounding_sum = surrounding_GWRPM25_sum)

data_firm_wind_pollution_surrounding
```

Save as RDS
```{r}
# Save
write_rds(data_firm_wind_pollution_surrounding, "./data/data_firm_wind_pollution_surrounding.rds", compress = "gz")
# Restore
data_firm_wind_pollution_surrounding <- read_rds("./data/data_firm_wind_pollution_surrounding.rds")
```

### Cone weighted average
Vectorized `cone_average_func`. This is faster but may lead to problems because of memory requirements.
```{r}
cone_func <- function(point, distance = 10000, angle, width = 45) {
  coordinates <- st_coordinates(point)
  angles <- angle - width/2 + seq(0, width, by = 2)
  angle.point <- lapply(angles, function(x) geosphere::destPoint(coordinates, b = x, d = distance))
  m <- matrix(unlist(angle.point), ncol = 2, byrow = TRUE)
  allpoints <- rbind(coordinates, m, coordinates)
  cone <- st_polygon(list(allpoints)) %>% st_sfc()
  st_crs(cone) <- st_crs(point)
  return(cone)
}

cone_average_func <- function(cone, point) {
  point_df <- tibble(geom_point = point) %>%
    mutate(ID = 1:nrow(.)) %>%
    st_as_sf()
  
  terra::extract(data_wind_pollution$GWRPM25, vect(cone), xy = TRUE, touches = TRUE, ID = TRUE) %>%
    drop_na() %>%
    left_join(point_df, by = "ID") %>%
    st_as_sf(coords = c("x", "y")) %>%
    st_set_crs(4326) %>%
    mutate(distance = st_distance(geometry, geom_point, by_element = TRUE)) %>%
    mutate(weight = drop_units(distance)^-0.5) %>%
    st_drop_geometry() %>%
    summarise(mean_GWRPM25 = weighted.mean(GWRPM25, weight), .by = ID) %>%
    pull(mean_GWRPM25)
}
```

```{r}
# Setting up batches
batch_size <- 1000
num_batches <- ceiling(nrow(data_firm_wind_pollution) / batch_size)

# Initialize an empty list to store the results
result <- list()

# Setting up progress bar
pb <- progress_bar$new(format = "(:spin) :percent [:current/:total || Time: :elapsedfull || ETA: :eta]",
                       total = num_batches,
                       clear = FALSE)

# Process each batch using a loop
for (i in 1:num_batches) {
  pb$tick()
  
  start_index <- (i - 1) * batch_size + 1
  end_index <- min(i * batch_size, nrow(data_firm_wind_pollution))
  
  batch <- data_firm_wind_pollution[start_index:end_index, ]
  
  batch_result <- batch %>%
    rowwise() %>%
    mutate(geom_cone = cone_func(point = geometry, angle = wind_dir)) %>%
    ungroup() %>%
    mutate(GWRPM25_mean = cone_average_func(cone = geom_cone, point = geometry)) %>%
    st_drop_geometry() %>%
    select(firm_code, year, GWRPM25_mean)
  
  result[[i]] <- batch_result
}

# Combine the results into a single data frame
data_firm_wind_pollution_cone_average <- map_dfr(result, identity)
```

Save to RDS file
```{r}
# Save
write_rds(data_firm_wind_pollution_cone_average, file = "./data/data_firm_wind_pollution_cone_average.rds", compress = "gz")
# Restore
data_firm_wind_pollution_cone_average <- read_rds(file = "./data/data_firm_wind_pollution_cone_average.rds")
```

### Cone sum
Creating cone sum function
```{r}
cone_sum_func <- function(cone, point) {
  point_df <- tibble(geom_point = point) %>%
    mutate(ID = 1:nrow(.)) %>%
    st_as_sf()
  
  terra::extract(data_wind_pollution$GWRPM25, vect(cone), xy = TRUE, touches = TRUE, ID = TRUE) %>%
    drop_na() %>%
    left_join(point_df, by = "ID") %>%
    summarise(mean_GWRPM25 = sum(GWRPM25), .by = ID) %>%
    pull(mean_GWRPM25)
}
```

```{r}
# Setting up batches
batch_size <- 1000
num_batches <- ceiling(nrow(data_firm_wind_pollution) / batch_size)

# Initialize an empty list to store the results
result <- list()

# Setting up progress bar
pb <- progress_bar$new(format = "(:spin) :percent [:current/:total || Time: :elapsedfull || ETA: :eta]",
                       total = num_batches,
                       clear = FALSE)

# Process each batch using a loop
for (i in 1:num_batches) {
  pb$tick()
  
  start_index <- (i - 1) * batch_size + 1
  end_index <- min(i * batch_size, nrow(data_firm_wind_pollution))
  
  batch <- data_firm_wind_pollution[start_index:end_index, ]
  
  batch_result <- batch %>%
    rowwise() %>%
    mutate(geom_cone = cone_func(point = geometry, angle = wind_dir)) %>%
    ungroup() %>%
    mutate(GWRPM25_sum = cone_sum_func(cone = geom_cone, point = geometry)) %>%
    st_drop_geometry() %>%
    select(firm_code, year, GWRPM25_sum)
  
  result[[i]] <- batch_result
}

# Combine the results into a single data frame
#data_firm_wind_pollution_cone_sum <- do.call(rbind, result)

# Combine the dataframes into a single dataframe
data_firm_wind_pollution_cone_sum <- map_dfr(result, identity)
```

Save to RDS file
```{r}
# Save
write_rds(data_firm_wind_pollution_cone_sum, file = "./data/data_firm_wind_pollution_cone_sum.rds", compress = "gz")
# Restore
data_firm_wind_pollution_cone_sum <- read_rds(file = "./data/data_firm_wind_pollution_cone_sum.rds")
```

### Cone weighted average with windspeed
Working in batches
```{r}
# Find median overall windspeed
median_wind_speed <- terra::values(data_wind_pollution$wind_speed) %>%
  median(na.rm = TRUE)

# Setting up batches
batch_size <- 1000
num_batches <- ceiling(nrow(data_firm_wind_pollution) / batch_size)

# Initialize an empty list to store the results
result <- list()

# Setting up progress bar
pb <- progress_bar$new(format = "(:spin) :percent [:current/:total || Time: :elapsedfull || ETA: :eta]",
                       total = num_batches,
                       clear = FALSE)

# Process each batch using a loop
for (i in 1:num_batches) {
  pb$tick()
  
  start_index <- (i - 1) * batch_size + 1
  end_index <- min(i * batch_size, nrow(data_firm_wind_pollution))
  
  batch <- data_firm_wind_pollution[start_index:end_index, ]
  
  batch_result <- batch %>%
    rowwise() %>%
    mutate(geom_cone = cone_func(point = geometry, angle = wind_dir, 
                                 distance = if_else(wind_speed > median_wind_speed, 25000, 10000))) %>%
    ungroup() %>%
    mutate(GWRPM25_mean = cone_average_func(cone = geom_cone, point = geometry)) %>%
    st_drop_geometry() %>%
    select(firm_code, year, GWRPM25_mean)
  
  result[[i]] <- batch_result
}

# Combine the results into a single data frame
data_firm_wind_pollution_cone_average_windspeed <- map_dfr(result, identity)
```

Saving to RDS file
```{r}
# Save
write_rds(data_firm_wind_pollution_cone_average_windspeed, file = "./data/data_firm_wind_pollution_cone_average_windspeed.rds", compress = "gz")
# Restore
data_firm_wind_pollution_cone_average_windspeed <- read_rds("./data/data_firm_wind_pollution_cone_average_windspeed.rds")
```

### Cone sum with windspeed
Working in batches of 10000
```{r}
# Find median overall windspeed
median_wind_speed <- terra::values(data_wind_pollution$wind_speed) %>%
  median(na.rm = TRUE)

# Setting up batches
batch_size <- 1000
num_batches <- ceiling(nrow(data_firm_wind_pollution) / batch_size)

# Initialize an empty list to store the results
result <- list()

# Setting up progress bar
pb <- progress_bar$new(format = "(:spin) :percent [:current/:total || Time: :elapsedfull || ETA: :eta]",
                       total = num_batches,
                       clear = FALSE)

# Process each batch using a loop
for (i in 1:num_batches) {
  pb$tick()
  
  start_index <- (i - 1) * batch_size + 1
  end_index <- min(i * batch_size, nrow(data_firm_wind_pollution))
  
  batch <- data_firm_wind_pollution[start_index:end_index, ]
  
  batch_result <- batch %>%
    rowwise() %>%
    mutate(geom_cone = cone_func(point = geometry, angle = wind_dir, 
                                 distance = if_else(wind_speed > median_wind_speed, 25000, 10000))) %>%
    ungroup() %>%
    mutate(GWRPM25_sum = cone_sum_func(cone = geom_cone, point = geometry)) %>%
    st_drop_geometry() %>%
    select(firm_code, year, GWRPM25_sum)
  
  result[[i]] <- batch_result
}

# Combine the results into a single data frame
data_firm_wind_pollution_cone_sum_windspeed <- map_dfr(result, identity)
```

Save to RDS file
```{r}
# Save
write_rds(data_firm_wind_pollution_cone_sum_windspeed, file = "./data/data_firm_wind_pollution_cone_sum_windspeed.rds", compress = "gz")
# Restore
data_firm_wind_pollution_cone_sum_windspeed <- read_rds(file = "./data/data_firm_wind_pollution_cone_sum_windspeed.rds")
```

## Combining to one object
firm_code and all pollution values 1 to 6

```{r}
# Import data from .rds files
data_firm_wind_pollution_no_geom <- read_rds("./data/data_firm_wind_pollution.rds") %>%
  st_drop_geometry() %>%
  select(firm_code, year, wind_speed, wind_dir, GWRPM25)

data_firm_wind_pollution_surrounding <- read_rds("./data/data_firm_wind_pollution_surrounding.rds")
data_firm_wind_pollution_cone_average <- read_rds("./data/data_firm_wind_pollution_cone_average.rds") %>%
  rename(GWRPM25_cone_mean = GWRPM25_mean)
data_firm_wind_pollution_cone_sum <- read_rds("./data/data_firm_wind_pollution_cone_sum.rds") %>%
  rename(GWRPM25_cone_sum = GWRPM25_sum)
data_firm_wind_pollution_cone_average_windspeed <- read_rds("./data/data_firm_wind_pollution_cone_average_windspeed.rds") %>%
  rename(GWRPM25_cone_windspeed_mean = GWRPM25_mean)
data_firm_wind_pollution_cone_sum_windspeed <- read_rds("./data/data_firm_wind_pollution_cone_sum_windspeed.rds") %>%
  rename(GWRPM25_cone_windspeed_sum = GWRPM25_sum)

# Because I dont use joins but just add the columns, the order of firm_code and year is important
identical(data_firm_wind_pollution_no_geom$firm_code, data_firm_wind_pollution_surrounding$firm_code)
identical(data_firm_wind_pollution_no_geom$firm_code, data_firm_wind_pollution_cone_average$firm_code)
identical(data_firm_wind_pollution_no_geom$firm_code, data_firm_wind_pollution_cone_sum$firm_code)
identical(data_firm_wind_pollution_no_geom$firm_code, data_firm_wind_pollution_cone_average_windspeed$firm_code)
identical(data_firm_wind_pollution_no_geom$firm_code, data_firm_wind_pollution_cone_sum_windspeed$firm_code)

# Combining all data
data_firm_wind_pollution_combined <- data_firm_wind_pollution_no_geom %>%
  mutate(GWRPM25_surrounding_mean = data_firm_wind_pollution_surrounding$GWRPM25_surrounding_mean,
         GWRPM25_surrounding_sum = data_firm_wind_pollution_surrounding$GWRPM25_surrounding_sum,
         GWRPM25_cone_mean = data_firm_wind_pollution_cone_average$GWRPM25_cone_mean,
         GWRPM25_cone_sum = data_firm_wind_pollution_cone_sum$GWRPM25_cone_sum,
         GWRPM25_cone_windspeed_mean = data_firm_wind_pollution_cone_average_windspeed$GWRPM25_cone_windspeed_mean,
         GWRPM25_cone_windspeed_sum = data_firm_wind_pollution_cone_sum_windspeed$GWRPM25_cone_windspeed_sum)

data_firm_wind_pollution_combined
```

Write combined data to .rds and .csv
```{r}
# Save
write_rds(data_firm_wind_pollution_combined, "./data/data_firm_wind_pollution_combined.rds", compress = "gz")
write_csv(data_firm_wind_pollution_combined, "./data/data_firm_wind_pollution_combined.csv.gz")

# Restore
data_firm_wind_pollution_combined <- read_rds("./data/data_firm_wind_pollution_combined.rds")
```

